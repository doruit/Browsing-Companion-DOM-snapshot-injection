name: Deploy Backend Services

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - '.github/workflows/backend-deploy.yml'

permissions:
  id-token: write
  contents: read

jobs:
  check-infrastructure:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Authenticate with Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Verify Infrastructure Exists
        uses: azure/CLI@v1
        with:
          inlineScript: |
            RESOURCE_GROUP="rg-brow-comp-dev-01"
            if $(az group exists --name $RESOURCE_GROUP); then
              echo "Infrastructure resource group '$RESOURCE_GROUP' exists."
            else
              echo "::error::Infrastructure resource group '$RESOURCE_GROUP' does not exist. Please run the infrastructure deployment (infra-deploy.yml) first."
              exit 1
            fi

  deploy-gateway:
    needs: check-infrastructure
    runs-on: ubuntu-latest
    environment: dev
    timeout-minutes: 45
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure Node.js Runtime
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and Package Gateway Artifact
        working-directory: ./services/api-gateway
        run: |
          npm ci --omit=dev
          zip -r release.zip .

      - name: Authenticate with Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve Gateway Web App Resource
        id: discover
        run: |
          RESOURCE_GROUP="rg-brow-comp-dev-01"
          echo "Searching for Gateway Web App in $RESOURCE_GROUP..."
          APP_NAME=$(az webapp list --resource-group $RESOURCE_GROUP --query "[?starts_with(name, 'app-gateway')].name | [0]" -o tsv)
          
          if [ -z "$APP_NAME" ]; then
            echo "::error::Could not find Web App starting with 'app-gateway'..."
            exit 1
          fi
          
          echo "Found Gateway App: $APP_NAME"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Deploy Artifact to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.discover.outputs.app_name }}
          package: ./services/api-gateway/release.zip

  deploy-ai-service:
    needs: check-infrastructure
    runs-on: ubuntu-latest
    environment: dev
    timeout-minutes: 45
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure Python Runtime
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build and Package AI Service Artifact
        working-directory: ./services/ai-service
        run: |
          # Just zip the code, Azure App Service (Oryx) handles build if requirements.txt exists
          zip -r release.zip .

      - name: Authenticate with Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve AI Service Web App Resource
        id: discover
        run: |
          RESOURCE_GROUP="rg-brow-comp-dev-01"
          echo "Searching for AI Service Web App in $RESOURCE_GROUP..."
          APP_NAME=$(az webapp list --resource-group $RESOURCE_GROUP --query "[?starts_with(name, 'app-ai')].name | [0]" -o tsv)
          
          if [ -z "$APP_NAME" ]; then
            echo "::error::Could not find Web App starting with 'app-ai'..."
            exit 1
          fi
          
          echo "Found AI Service App: $APP_NAME"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Deploy Artifact to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.discover.outputs.app_name }}
          package: ./services/ai-service/release.zip
